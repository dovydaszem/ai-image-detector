<!DOCTYPE html>
<html>
<head>
    <title>AI Image Detector</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

        :root {
            --ink: #0d0f14;
            --muted: #626468;
            --accent: #ffd4c1;
            --accent-2: #c8f0ff;
            --panel: #ffffff;
            --shadow: rgba(15, 15, 20, 0.2);
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center; /* horizontal centering */
            justify-content: center; /* vertical centering */
            min-height: 100vh; /* 100vh = 100% viewport height */
            font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
            color: var(--ink);
            background:
                radial-gradient(1200px 600px at 10% 10%, #fff1e9 0%, rgba(255, 241, 233, 0) 60%),
                radial-gradient(1000px 500px at 90% 20%, #e7f7ff 0%, rgba(231, 247, 255, 0) 60%),
                linear-gradient(180deg, #ffffff 0%, #f7f8fb 100%);
        }

        /* Choose file and Predict buttons section*/
        #uploadForm {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 30px; /* space between buttons */
            align-items: center;
            justify-content: center;
        }

        /* main box */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background: var(--panel);
            border-radius: 15px;
            margin: 50px;
            padding: 30px 30px;
            box-shadow: 0 0 40px var(--shadow);
        }

        /* description box */
        .description {
            width: 80%;
            max-width: 800px;
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--muted);
            line-height: 1.5;
            text-align: left;
        }

        /* preview of the uploaded image */
        #preview {
            max-width: 500px;
            border-radius: 8px;
        }

        /* Predict and Choose file buttons */
        .btn {
            font-family: inherit;
            font-size: 16px;
            line-height: 1;
            border-radius: 999px;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: var(--ink);
            display: inline-flex;
            align-items: center;
            gap: 70px;
            white-space: nowrap;
        }

        .btn:hover,
        .btn:focus-visible {
            background: linear-gradient(135deg, #ff9e74 0%, #73daff 100%);
        }

        /* filename inside button */
        .btn .file-name {
            font-size: inherit;
            color: var(--muted);
            margin-left: 0;
        }

        /* heatmap button */
        .btn-icon {
            width: 0;
            height: 0;
            padding: 0;
            border: none;
            background: url("heatmap_icon.png") center/contain no-repeat;
            opacity: 0;
            transform: translateX(-21px);
            transition: opacity 200ms ease, transform 200ms ease, width 200ms ease, height 200ms ease, filter 200ms ease;
            pointer-events: none;
            overflow: hidden;
            filter: grayscale(0) opacity(0.65);
            cursor: pointer;
        }

        .btn-icon.is-visible {
            width: 42px;
            height: 42px;
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .btn-icon.grayscale {
            filter: grayscale(1) opacity(0.65);
        }

        .btn-icon:hover {
            filter: grayscale(0) opacity(1);
        }

        .btn-icon.grayscale:hover {
            filter: grayscale(1) opacity(1);
        }
    </style>
    
</head>
<body>
    <div class="container">
        <h1>Interpretable AI Image Detector</h1>
        
        <div class="description">
            <h3>Overview</h3>
            <p>
                This tool uses a custom convolutional neural network (CNN) to identify
                synthetic patterns indicative of generative AI.
        </p>
            </p>

            <h3>Interpretability</h3>
            <p>
                When an AI generated image is detected, the tool provides a heatmap overlay
                based on Grad-CAM technology, telling which parts of a given image most
                influence the modelâ€™s decision. Note that the heatmap may not always be
                intuitive, giving you a glimpse into the model's decision process, which is
                different from that of a human's.
            </p>
        </div>

        <h2>Upload an image</h2>

        <form id="uploadForm">
            <input type="file" id="fileInput" name="file" style="display:none;">
            <label for="fileInput" class="btn">
                <span>Choose file</span>
                <span id="fileName" class="file-name">None chosen</span>
            </label>

            <input type="submit" class="btn" value="Predict">
            <button id="toggleHeatmap" class="btn-icon" type="button" aria-label="Toggle heatmap"></button>
        </form>

        <img id="preview" style="display:none; margin-bottom:10px;">
        <h3 id="resultText"></h3>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const uploadForm = document.getElementById('uploadForm');
        const resultText = document.getElementById('resultText');
        const toggleHeatmap = document.getElementById('toggleHeatmap');
        const fileName = document.getElementById('fileName');

        // store the original image source to reset the preview
        let originalSrc = "";
        let heatmapSrc = "";
        let heatmapVisible = false;

        const setHeatmapButtonVisible = (visible) => {
            toggleHeatmap.classList.toggle('is-visible', visible);
        };

        fileInput.onchange = e => {
            const [file] = e.target.files;
            if (file) {
                // revoke old url to prevent memory leaks
                if (originalSrc) URL.revokeObjectURL(originalSrc);
                
                originalSrc = URL.createObjectURL(file);
                preview.src = originalSrc;
                preview.style.display = "block"; // show only when image exists
                resultText.innerText = ""; 
                heatmapSrc = "";
                heatmapVisible = false;
                setHeatmapButtonVisible(false);
                fileName.textContent = file.name;
            } else {
                fileName.textContent = "None chosen";
            }
        };

        uploadForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!fileInput.files[0]) return;

            preview.src = originalSrc;
            heatmapSrc = "";
            heatmapVisible = false;
            setHeatmapButtonVisible(false);

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            resultText.style.color = "black";
            resultText.innerText = "Analysing...";

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    resultText.innerText = "error: " + data.error;
                    resultText.style.color = "black";
                } else {
                    resultText.innerText = `${data.verdict}`;

                    if (data.is_ai) {
                        resultText.style.color = "#c91231";

                        const heatmap = new Image();
                        heatmap.src = `data:image/png;base64,${data.heatmap}`;
                        heatmap.onload = () => {
                            const baseImg = new Image();
                            baseImg.src = originalSrc;
                            baseImg.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = baseImg.naturalWidth;
                                canvas.height = baseImg.naturalHeight;
                                const ctx = canvas.getContext('2d');

                                ctx.drawImage(baseImg, 0, 0);
                                ctx.globalAlpha = data.alpha;
                                ctx.drawImage(heatmap, 0, 0, canvas.width, canvas.height);
                                heatmapSrc = canvas.toDataURL();
                                preview.src = heatmapSrc;
                                heatmapVisible = true;
                                setHeatmapButtonVisible(true);
                            };
                        };
                    } else {
                        resultText.style.color = "#12c96e";
                        preview.src = originalSrc;
                    }
                }

            } catch (err) {
                resultText.innerText = "request failed";
                resultText.style.color = "black";
            }
        };

        toggleHeatmap.onclick = () => {
            if (!heatmapSrc) return;
            heatmapVisible = !heatmapVisible;
            preview.src = heatmapVisible ? heatmapSrc : originalSrc;
            toggleHeatmap.classList.toggle('grayscale', !heatmapVisible);
        };
    </script>
</body>
</html>